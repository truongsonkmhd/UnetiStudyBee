package com.truongsonkmhd.unetistudy.repository.course;

import com.truongsonkmhd.unetistudy.common.CourseStatus;
import com.truongsonkmhd.unetistudy.dto.course_dto.CourseCardResponse;
import com.truongsonkmhd.unetistudy.model.course.Course;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;
import java.util.UUID;

@Repository
public interface CourseRepository extends JpaRepository<Course, UUID> {

  List<Course> findByStatus(CourseStatus status);

  boolean existsBySlug(String slug);

  Optional<Course> findBySlug(String slug);

  // ========== OFFSET PAGINATION ==========

  @Query(value = """
          select new com.truongsonkmhd.unetistudy.dto.course_dto.CourseCardResponse(
              c.courseId, c.title, c.slug, c.shortDescription, c.imageUrl, c.isPublished, CAST(size(c.modules) AS Integer), c.publishedAt
          )
          from Course c
          where c.isPublished = true
          order by
              case when c.publishedAt is null then 1 else 0 end,
              c.publishedAt desc,
              c.createdAt desc
      """, countQuery = """
          select count(c)
          from Course c
          where c.isPublished = true
      """)
  Page<CourseCardResponse> findPublishedCourseCards(Pageable pageable);

  @Query(value = """
          select new com.truongsonkmhd.unetistudy.dto.course_dto.CourseCardResponse(
              c.courseId, c.title, c.slug, c.shortDescription, c.imageUrl, c.isPublished, CAST(size(c.modules) AS Integer), c.publishedAt
          )
          from Course c
          where c.isPublished = true
            and (
                 lower(c.title) like lower(concat('%', cast(:q as string), '%'))
              or lower(c.slug)  like lower(concat('%', cast(:q as string), '%'))
            )
          order by
              case when c.publishedAt is null then 1 else 0 end,
              c.publishedAt desc,
              c.createdAt desc
      """, countQuery = """
          select count(c)
          from Course c
          where c.isPublished = true
            and (
                 lower(c.title) like lower(concat('%', :q, '%'))
              or lower(c.slug)  like lower(concat('%', :q, '%'))
            )
      """)
  Page<CourseCardResponse> searchPublishedCourseCards(@Param("q") String q, Pageable pageable);

  // ========== CURSOR PAGINATION ==========

  @Query("""
          select new com.truongsonkmhd.unetistudy.dto.course_dto.CourseCardResponse(
              c.courseId, c.title, c.slug, c.shortDescription, c.imageUrl, c.isPublished, CAST(size(c.modules) AS Integer), c.publishedAt
          )
          from Course c
          where c.isPublished = true
            and (
                 c.publishedAt < :publishedAt
              or (c.publishedAt = :publishedAt and c.courseId < :lastId)
              or c.publishedAt is null
            )
          order by
              case when c.publishedAt is null then 1 else 0 end,
              c.publishedAt desc,
              c.createdAt desc
      """)
  Page<CourseCardResponse> findPublishedCourseCardsAfterCursor(
      @Param("publishedAt") LocalDateTime publishedAt,
      @Param("lastId") UUID lastId,
      Pageable pageable);

  @Query(value = """
          select new com.truongsonkmhd.unetistudy.dto.course_dto.CourseCardResponse(
              c.courseId,
              c.title,
              c.slug,
              c.shortDescription,
              c.imageUrl,
              c.isPublished,
              CAST(size(c.modules) AS Integer),
              c.publishedAt
          )
          from Course c
          where (cast(:q as string) is null or lower(c.title) like lower(concat('%', cast(:q as string), '%'))
                 or lower(c.slug) like lower(concat('%', cast(:q as string), '%')))
            and (cast(:status as string) is null or c.status = :status)
            and (cast(:category as string) is null or c.category = :category)
          order by c.createdAt desc
      """)
  Page<CourseCardResponse> findCourseCardsWithFilters(
      @Param("q") String q,
      @Param("status") CourseStatus status,
      @Param("category") String category,
      Pageable pageable);

  @Query("""
          select new com.truongsonkmhd.unetistudy.dto.course_dto.CourseCardResponse(
              c.courseId, c.title, c.slug, c.shortDescription, c.imageUrl, c.isPublished, CAST(size(c.modules) AS Integer), c.publishedAt
          )
          from Course c
          where c.isPublished = true
            and (
                 lower(c.title) like lower(concat('%', cast(:q as string), '%'))
              or lower(c.slug)  like lower(concat('%', cast(:q as string), '%'))
            )
            and (
                 c.publishedAt < :publishedAt
              or (c.publishedAt = :publishedAt and c.courseId < :lastId)
              or c.publishedAt is null
            )
          order by
              case when c.publishedAt is null then 1 else 0 end,
              c.publishedAt desc,
              c.createdAt desc
      """)
  Page<CourseCardResponse> searchPublishedCourseCardsAfterCursor(
      @Param("q") String q,
      @Param("publishedAt") LocalDateTime publishedAt,
      @Param("lastId") UUID lastId,
      Pageable pageable);
}